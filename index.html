<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

    <title>國際遊戲協會</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <!-- Header -->
    <header class="bg-light py-3">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-5 d-flex justify-content-center">
                    <img src="img/logogif.gif" alt="Logo" class="img-fluid" style="max-width: 80px;">
                </div>
                <div class="col-md-7">
                    <nav class="d-flex justify-content-center">
                        <ul class="nav">
                            <li class="nav-item"><a class="nav-link" href="index.html">首頁</a></li>
                            <li class="nav-item"><a class="nav-link" href="about.html">關於我們</a></li>
                            <li class="nav-item"><a class="nav-link" href="member.html">成員介紹</a></li>
                            <li class="nav-item"><a class="nav-link" href="news.html">最新消息</a></li>
                            <li class="nav-item"><a class="nav-link" href="course.html">課程介紹</a></li>
                            <li class="nav-item"><a class="nav-link" href="contact.html">聯絡我們</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </header>

    <!-- Banner -->
    <div class="container-fluid">
        <img src="img/banner.jpg" alt="Banner" class="img-fluid">
    </div>

    <!-- About Us -->
    <section class="py-5">
        <div class="container">
            <h2 class="text-center text-warning mb-4">關於我們</h2>
            <div class="row">
                <div class="col-md-6">
                    <img src="img/about.jpg" alt="About Us" class="img-fluid">
                </div>
                <div class="col-md-6 mt-3">
                    <p><strong>本會為國際遊戲協會在台灣成立的分會，為認同國際遊戲協會之宗旨，在台依法設立、非以營利為目的之社會團體。</strong>
                    </p>
                    <p><strong>我們的宗旨在促進兒童與家庭各年齡層的健康與教育福祉，以及依照聯合國兒童人權公約致力於保障所有兒童的遊戲權利。</strong>
                    </p>
                    <p><strong>增強人際互動功能，開展閒暇時間利用和遊戲學習方案，並著力於改善與提供遊戲環境、發展遊具、玩物與遊戲空間，國際遊戲協會台灣分會提供一個國際論壇平台，促進所有兒童、青年直至銀髮樂齡者之遊戲權利與機會。</strong>
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Latest News -->
    <section class="bg-light py-5">
        <div class="container">
            <h2 class="text-center text-warning mb-4">最新消息</h2>
            <div class="row" id="news-container">
                <!-- 這裡的內容將由 JavaScript 動態生成 -->
                <div class="col-12 text-center">
                    <p>載入中...</p>
                </div>
            </div>
            <div class="text-center mt-3">
                <button id="loadMoreNews" class="btn btn-outline-primary" style="display: none;">加載更多</button>
            </div>
        </div>
    </section>

    <!-- Photo Albums -->
    <section class="py-5">
        <div class="container">
            <h2 class="text-center text-warning mb-4">活動花絮</h2>
            <div class="row" id="photo-albums-container">
                <!-- 這裡的內容將由 JavaScript 動態生成 -->
                <div class="col-12 text-center">
                    <p>載入中...</p>
                </div>
            </div>
            <div class="text-center mt-3">
                <button id="loadMorePhotoAlbums" class="btn btn-outline-primary" style="display: none;">加載更多</button>
            </div>
        </div>
    </section>

    <!-- Courses Overview -->
    <section class="bg-light py-5">
        <div class="container">
            <h2 class="text-center text-warning mb-4">最新課程</h2>
            <div class="row" id="courses-container">
                <!-- 這裡的內容將由 JavaScript 動態生成 -->
                <div class="col-12 text-center">
                    <p>載入中...</p>
                </div>
            </div>
            <div class="text-center mt-3">
                <button id="loadMoreCourses" class="btn btn-outline-primary" style="display: none;">加載更多</button>
            </div>
        </div>
    </section>

    <!-- 新聞詳情模態框 -->
    <div class="modal fade" id="newsDetailModal" tabindex="-1" aria-labelledby="newsDetailModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newsDetailModalLabel">新聞詳情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="newsDetailContent">
                    <!-- 動態填充新聞詳情 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 課程詳情模態框 -->
    <div class="modal fade" id="courseDetailModal" tabindex="-1" aria-labelledby="courseDetailModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="courseDetailModalLabel">課程詳情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="courseDetailContent">
                    <!-- 動態填充課程詳情 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-3">
                    <div class="text-center">
                        <img src="img/logo-150x150.jpeg" alt="Logo" class="img-fluid mb-2" style="max-width: 100px;">
                    </div>
                    <p>遊戲 是最高形式的研究；樂育 是最高層次的學習。<br>
                        Play, is research in its highest form.<br>
                        Edutainment, is learning on its highest level.</p>
                </div>
                <div class="col-lg-4 mb-3">
                    <ul class="list-unstyled">
                        <li><i class="fa fa-map-marker"></i> 地址：220新北市板橋區中正路435號</li>
                        435藝文特區台灣玩具博物館
                        <li><i class="fa fa-fax"></i> 傳真：(02)8972-7185</li>
                        <li><i class="fa fa-envelope"></i> E-mail：<a href="mailto:ipat1071001@ipat.org.tw"
                                class="text-white">ipat1071001@ipat.org.tw</a></li>
                    </ul>


                </div>
                <div class="col-lg-4 text-center mb-3">
                    <ul class="list-inline">
                        <li class="list-inline-item"><a
                                href="https://www.facebook.com/IPAT-International-Play-Association-Taiwan-Branch-106772071551600"
                                target="_blank" rel="noopener noreferrer"><img src="img/facebook.png" alt="Facebook"
                                    class="img-fluid" style="max-width: 30px;"></a></li>
                        <li class="list-inline-item"><a
                                href="https://line.me/ti/g2/ftLDwke6OMbboIQNbkGf4Q?utm_source=invitation&amp;utm_medium=link_copy&amp;utm_campaign=default"
                                target="_blank" rel="noopener noreferrer"><img src="img/line.png" alt="Line"
                                    class="img-fluid" style="max-width: 30px;"></a></li>
                        <li class="list-inline-item"><a href="https://twitter.com/ipataiwan1" target="_blank"
                                rel="noopener noreferrer"><img src="img/twitter.png" alt="Twitter" class="img-fluid"
                                    style="max-width: 30px;"></a></li>
                        <li class="list-inline-item"><a href="https://www.instagram.com/ipataiwan/" target="_blank"
                                rel="noopener noreferrer"><img src="img/IG.png" alt="Instagram" class="img-fluid"
                                    style="max-width: 30px;"></a></li>
                        <li class="list-inline-item">
                            <a href="Backstage.html" target="_blank" rel="noopener noreferrer">
                                <img src="img/transparent.png" alt="Backstage" class="img-fluid"
                                    style="max-width: 30px; opacity: 0;">
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="text-center mt-3" <p>© Copyright 2025. 網頁設計 By Zero.Lin</p>
            </div>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-auth-compat.js"></script>
    <script src="js/firebase-data.js"></script>
    <script src="js/news.js"></script>
    <script src="js/course.js"></script>
    <script src="js/photo_album.js"></script>

    <script>
        // 頁面加載時從 Firebase 獲取最新消息和課程資料
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                console.log("index.html 開始載入資料");

                // 確認 dataManager 是否正確初始化
                if (!window.dataManager) {
                    console.error("dataManager 未初始化");
                    alert("資料管理器初始化失敗，請重新載入頁面");
                    return;
                }

                // 獲取最新消息
                const newsData = await window.dataManager.getNews();
                window.allNewsItems = newsData; // 儲存所有新聞數據
                updateNewsSection(newsData, 0, 6); // 初始加載6條

                // 獲取課程資料
                const coursesData = await window.dataManager.getCourses();
                console.log("coursesData", coursesData);
                window.allCoursesItems = coursesData; // 儲存所有課程數據
                updateCoursesSection(coursesData, 0, 6); // 初始加載6條

                // 獲取活動花絮
                const photoAlbumsData = await window.dataManager.getPhotoAlbum();
                console.log("photoAlbumsData", photoAlbumsData);
                window.allPhotoAlbumsItems = photoAlbumsData; // 儲存所有活動花絮數據
                updatePhotoAlbumsSection(photoAlbumsData, 0, 6); // 初始加載6條

                // 綁定「加載更多」按鈕事件
                setupLoadMoreButtons();
            } catch (error) {
                console.error('載入資料時出錯:', error);
            }
        });

        // 綁定「加載更多」按鈕事件
        function setupLoadMoreButtons() {
            // 新聞加載更多
            document.getElementById('loadMoreNews').addEventListener('click', function() {
                const currentCount = document.querySelectorAll('#news-container .card').length;
                updateNewsSection(window.allNewsItems, currentCount, currentCount + 6);
            });

            // 活動花絮加載更多
            document.getElementById('loadMorePhotoAlbums').addEventListener('click', function() {
                const currentCount = document.querySelectorAll('#photo-albums-container .card').length;
                updatePhotoAlbumsSection(window.allPhotoAlbumsItems, currentCount, currentCount + 6);
            });

            // 課程加載更多
            document.getElementById('loadMoreCourses').addEventListener('click', function() {
                const currentCount = document.querySelectorAll('#courses-container .card').length;
                updateCoursesSection(window.allCoursesItems, currentCount, currentCount + 6);
            });
        }

        // 格式化課程時間
        function formatCourseTime(course) {
            // 如果有 time 或 date 屬性，優先使用
            if (course.time) return course.time;
            if (course.date) return course.date;

            // 如果有 startdate 和 enddate
            if (course.startdate && course.enddate) {
                let startDate, endDate;

                // 處理不同的日期格式
                if (typeof course.startdate === 'string') {
                    startDate = new Date(course.startdate);
                } else if (course.startdate.toDate) {
                    // Firestore Timestamp
                    startDate = course.startdate.toDate();
                } else {
                    startDate = new Date(course.startdate);
                }

                if (typeof course.enddate === 'string') {
                    endDate = new Date(course.enddate);
                } else if (course.enddate.toDate) {
                    // Firestore Timestamp
                    endDate = course.enddate.toDate();
                } else {
                    endDate = new Date(course.enddate);
                }

                // 格式化日期
                const formatDate = (date) => {
                    return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
                };

                // 格式化時間
                const formatTime = (date) => {
                    return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                };

                // 檢查是否同一天
                const isSameDay = startDate.getFullYear() === endDate.getFullYear() &&
                    startDate.getMonth() === endDate.getMonth() &&
                    startDate.getDate() === endDate.getDate();

                if (isSameDay) {
                    return `${formatDate(startDate)} ${formatTime(startDate)}~${formatTime(endDate)}`;
                } else {
                    return `${formatDate(startDate)} ${formatTime(startDate)}~${formatDate(endDate)} ${formatTime(endDate)}`;
                }
            }

            return '無資料';
        }

        // 更新最新消息區域
        function updateNewsSection(newsItems, start, end) {
            const newsContainer = document.getElementById('news-container');
            const loadMoreBtn = document.getElementById('loadMoreNews');
            if (!newsContainer) return;

            // 首次加載時清空容器
            if (start === 0) {
                newsContainer.innerHTML = '';
            }

            if (!newsItems || newsItems.length === 0) {
                newsContainer.innerHTML = '<div class="col-12 text-center"><p>目前沒有最新消息</p></div>';
                loadMoreBtn.style.display = 'none';
                return;
            }

            // 選擇要顯示的新聞範圍
            const itemsToShow = newsItems.slice(start, end);

            // 根據是否還有更多數據決定是否顯示「加載更多」按鈕
            if (end >= newsItems.length) {
                loadMoreBtn.style.display = 'none';
            } else {
                loadMoreBtn.style.display = 'inline-block';
            }

            // 添加新的新聞卡片
            itemsToShow.forEach((news, index) => {
                // 計算實際索引（用於顯示詳情時）
                const actualIndex = start + index;
                
                // 格式化日期顯示
                let dateDisplay = '無日期';
                if (news.updatetime) {
                    try {
                        const date = news.updatetime.toDate ? news.updatetime.toDate() : new Date(news.updatetime);
                        dateDisplay = date.toLocaleDateString('zh-TW', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    } catch (error) {
                        console.error('格式化日期時出錯:', error);
                    }
                }

                const newsDiv = document.createElement('div');
                newsDiv.className = 'col-md-4 mb-4';
                newsDiv.innerHTML = `
                    <div class="card h-100" style="cursor: pointer;" onclick="showNewsDetail(${actualIndex})">
                        <div class="card-body">
                            <h5 class="card-title">${news.title || '無標題'}</h5>
                            <p class="card-text">${news.content ? news.content.substring(0, 20) + (news.content.length > 20 ? '...' : '') : '無內容'}</p>
                        </div>
                        <div class="card-footer">
                            <small class="text-muted">更新時間：${dateDisplay}</small>
                        </div>
                    </div>
                `;
                newsContainer.appendChild(newsDiv);
            });
        }

        // 更新活動花絮區域
        function updatePhotoAlbumsSection(photoAlbumsItems, start, end) {
            const photoAlbumsContainer = document.getElementById('photo-albums-container');
            const loadMoreBtn = document.getElementById('loadMorePhotoAlbums');
            if (!photoAlbumsContainer) return;

            // 首次加載時清空容器
            if (start === 0) {
                photoAlbumsContainer.innerHTML = '';
            }

            if (!photoAlbumsItems || photoAlbumsItems.length === 0) {
                photoAlbumsContainer.innerHTML = '<div class="col-12 text-center"><p>目前沒有活動花絮</p></div>';
                loadMoreBtn.style.display = 'none';
                return;
            }

            // 選擇要顯示的活動花絮範圍
            const itemsToShow = photoAlbumsItems.slice(start, end);

            // 根據是否還有更多數據決定是否顯示「加載更多」按鈕
            if (end >= photoAlbumsItems.length) {
                loadMoreBtn.style.display = 'none';
            } else {
                loadMoreBtn.style.display = 'inline-block';
            }

            // 添加新的活動花絮卡片
            itemsToShow.forEach((album) => {
                console.log("album", album);
                const albumDiv = document.createElement('div');
                albumDiv.className = 'col-md-4 mb-4';
                
                // 準備圖片URL
                let imageUrl = `https://firebasestorage.googleapis.com/v0/b/ipat-database.firebasestorage.app/o/photo_album%2F${album.id}.webp?alt=media`;
                
                albumDiv.innerHTML = `
                    <div class="card h-100" style="cursor: pointer;" onclick="window.open('${album.url}', '_blank')">
                        <img src="${imageUrl}" class="card-img-top album-cover" alt="${album.title || '活動照片'}" 
                             onerror="this.onerror=null; this.style.display='none';" 
                             style="height: 200px; object-fit: cover;">
                        <div class="card-footer">
                            <div class="text-muted text-center">${album.title || '無標題'}</div>
                        </div>
                    </div>
                `;
                photoAlbumsContainer.appendChild(albumDiv);
            });
        }

        // 更新課程區域
        function updateCoursesSection(coursesItems, start, end) {
            const coursesContainer = document.getElementById('courses-container');
            const loadMoreBtn = document.getElementById('loadMoreCourses');
            if (!coursesContainer) return;

            // 首次加載時清空容器
            if (start === 0) {
                coursesContainer.innerHTML = '';
            }

            if (!coursesItems || coursesItems.length === 0) {
                coursesContainer.innerHTML = '<div class="col-12 text-center"><p>目前沒有最新課程</p></div>';
                loadMoreBtn.style.display = 'none';
                return;
            }

            // 選擇要顯示的課程範圍
            const itemsToShow = coursesItems.slice(start, end);

            // 根據是否還有更多數據決定是否顯示「加載更多」按鈕
            if (end >= coursesItems.length) {
                loadMoreBtn.style.display = 'none';
            } else {
                loadMoreBtn.style.display = 'inline-block';
            }

            // 添加新的課程卡片
            itemsToShow.forEach((course, index) => {
                // 計算實際索引（用於顯示詳情時）
                const actualIndex = start + index;
                
                const courseTime = formatCourseTime(course);
                
                const courseDiv = document.createElement('div');
                courseDiv.className = 'col-md-4 mb-4';
                courseDiv.innerHTML = `
                    <div class="card h-100" style="cursor: pointer;" onclick="showCourseDetail(${actualIndex})">
                        <div class="card-body">
                            <h5 class="card-title">${course.title || '無標題'}</h5>
                            <p class="card-text">
                                <small class="text-muted">授課教師: ${course.teacher || '未指定'}</small><br>
                                <small class="text-muted">上課時間: ${courseTime}</small><br>
                                <small class="text-muted">課程費用: NT＄${course.price || 0}</small>
                            </p>
                        </div>
                    </div>
                `;
                coursesContainer.appendChild(courseDiv);
            });
        }

        // 顯示新聞詳情模態框
        function showNewsDetail(index) {
            const news = window.allNewsItems[index];
            if (!news) return;

            // 格式化日期顯示
            let dateDisplay = '無日期';
            if (news.updatetime) {
                const date = typeof news.updatetime === 'number'
                    ? new Date(news.updatetime)
                    : new Date(news.updatetime);
                dateDisplay = date.toLocaleDateString('zh-TW', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            // 設置模態框標題和內容
            document.getElementById('newsDetailModalLabel').textContent = news.title || '無標題';

            const modalContent = document.getElementById('newsDetailContent');
            modalContent.innerHTML = `
                <div class="row">
                    <div id="news-image-container" class="col-md-12 mb-3" style="display: none;">
                        <!-- 圖片將在下方動態添加 -->
                    </div>
                    <div class="col-md-12">
                        <p>${news.content || '無內容'}</p>
                        ${news.description ? `<p><strong>簡介：</strong> ${news.description}</p>` : ''}
                    </div>
                    ${renderUrlLinks(news.urls)}
                    <div class="col-md-12 mt-3">
                       <small class="text-muted">更新時間：${dateDisplay}</small>
                    </div>
                </div>
            `;

            // 嘗試從 Firebase Storage 獲取圖片
            if (news.id) {
                const imageUrl = `https://firebasestorage.googleapis.com/v0/b/ipat-database.firebasestorage.app/o/news%2F${news.id}.webp?alt=media`;
                const img = new Image();
                const imageContainer = document.getElementById('news-image-container');

                img.onload = function () {
                    // 圖片載入成功時顯示
                    img.className = 'img-fluid';
                    img.alt = news.title || '新聞圖片';
                    imageContainer.innerHTML = '';
                    imageContainer.appendChild(img);
                    imageContainer.style.display = 'block';
                };

                img.onerror = function () {
                    // 圖片載入失敗時隱藏容器
                    console.log(`無法載入新聞 ${news.id} 的圖片`);
                    imageContainer.style.display = 'none';
                };

                img.src = imageUrl;
            }

            // 顯示模態框
            new bootstrap.Modal(document.getElementById('newsDetailModal')).show();
        }

        // 顯示課程詳情模態框
        function showCourseDetail(index) {
            const course = window.allCoursesItems[index];
            if (!course) return;

            // 設置模態框標題和內容
            document.getElementById('courseDetailModalLabel').textContent = course.title || '無標題';

            const modalContent = document.getElementById('courseDetailContent');
            modalContent.innerHTML = `
                <div class="row">
                    <div id="course-image-container" class="col-md-12 mb-3" style="display: none;">
                        <!-- 圖片將在下方動態添加 -->
                    </div>
                    <div class="col-md-12">
                        <div class="row">
                            <div class="col-md-2">
                                <strong>授課教師：</strong><br>${course.teacher || '無資料'}
                            </div>                            
                            <div class="col-md-2">
                                <strong>課程費用：</strong><br>${course.price || 0}
                            </div>
                            <div class="col-md-4">
                                <strong>上課時間：</strong><br>${formatCourseTime(course)}
                            </div>
                            <div class="col-md-4">
                                <strong>上課地點：</strong><br>${course.location || '無資料'}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12 mt-3">
                        <p>${course.content || '無課程描述'}</p>
                        ${renderUrlLinks(course.urls)}
                        <p>＊若對此課程有興趣，請至上方課程介紹，了解完課程須知後，再於最新課程處報名。</p>
                    </div>
                </div>
            `;
            // 嘗試從 Firebase Storage 獲取圖片
            if (course.id) {
                const imageUrl = `https://firebasestorage.googleapis.com/v0/b/ipat-database.firebasestorage.app/o/course%2F${course.id}.webp?alt=media`;
                const img = new Image();
                const imageContainer = document.getElementById('course-image-container');

                img.onload = function () {
                    // 圖片載入成功時顯示
                    img.className = 'img-fluid';
                    img.alt = course.title || '課程圖片';
                    imageContainer.innerHTML = '';
                    imageContainer.appendChild(img);
                    imageContainer.style.display = 'block';
                };

                img.onerror = function () {
                    // 圖片載入失敗時隱藏容器
                    console.log(`無法載入新聞 ${course.id} 的圖片`);
                    imageContainer.style.display = 'none';
                };

                img.src = imageUrl;
            }
            // 顯示模態框
            new bootstrap.Modal(document.getElementById('courseDetailModal')).show();
        }
    
    // 處理URLs數組，將其轉換為HTML連結
    function renderUrlLinks(urls) {
            if (!urls || !Array.isArray(urls) || urls.length === 0) {
                return '';
            }
            
            let linksHtml = '<div class="col-md-12 mb-3"><div class="d-flex flex-wrap gap-2">';
            
            urls.forEach(urlItem => {
                const parts = urlItem.split('|||');
                if (parts.length === 2) {
                    const [text, link] = parts;
                    linksHtml += `<a href="${link}" class="btn btn-sm btn-outline-primary col-2" target="_blank">${text}</a>`;

                }
            });
            
            linksHtml += '</div></div>';
            return linksHtml;
        }
    </script>
</body>

</html>