<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>後台管理 - 國際遊戲協會</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        #loginSection {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #adminPanel {
            display: none;
        }

        .sidebar {
            min-height: calc(100vh - 56px);
            background-color: #f8f9fa;
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-storage-compat.js"></script>
    <!-- 引入資料管理模組 -->
    <script src="js/firebase-data.js"></script>
    <script src="js/table.js"></script>
    <script src="js/add.js"></script>
</head>

<body>
    <!-- 登入區域 -->
    <div id="loginSection" class="container">
        <div class="card shadow-sm" style="width: 100%; max-width: 400px;">
            <div class="card-header bg-primary text-white">
                <h4 class="text-center mb-0">管理員登入</h4>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="email" class="form-label">電子郵件</label>
                    <input type="email" class="form-control" id="email" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">密碼</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <div class="d-grid"><!-- 登入按鈕 -->
                    <button type="button" class="btn btn-primary" onclick="window.login()">登入</button>
                </div>
                <div id="loginError" class="text-danger mt-2"></div>
            </div>
        </div>
    </div>

    <!-- 管理介面 -->
    <div id="adminPanel">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">國際遊戲協會 - 後台管理</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <span class="nav-link" id="userEmail"></span>
                        </li>
                        <li class="nav-item">
                            <!-- 登出按鈕 -->
                            <a class="nav-link" href="#" onclick="window.logout()">登出</a>

                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <!-- 側邊欄 -->
                <div class="col-md-2 sidebar py-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="showTab('dashboard')">儀表板</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTab('news')">最新消息管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTab('courses')">課程管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTab('members')">成員管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTab('registrations')">報名資料管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTab('photoAlbums')">活動花絮管理</a>
                        </li>
                    </ul>
                </div>

                <!-- 主要內容區 -->
                <div class="col-md-10 py-3">
                    <!-- 儀表板頁面 -->
                    <div id="dashboard" class="tab-content">
                        <h2>儀表板</h2>
                        <div class="row mt-4">
                            <div class="col-md-3 mb-4">
                                <div class="card bg-primary text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">最新消息</h5>
                                        <p class="card-text display-4" id="newsCount">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-4">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">課程數量</h5>
                                        <p class="card-text display-4" id="coursesCount">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-4">
                                <div class="card bg-info text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">成員數量</h5>
                                        <p class="card-text display-4" id="membersCount">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-4">
                                <div class="card bg-warning text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">報名數量</h5>
                                        <p class="card-text display-4" id="registrationsCount">0</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>最近新增的消息</h5>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-group" id="recentNewsList"></ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>最新課程</h5>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-group" id="recentRegistrationsList"></ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 最新消息管理頁面 -->
                    <div id="news" class="tab-content" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2>最新消息管理</h2>
                            <div class="d-flex align-items-center">
                                <div class="input-group me-3">
                                    <input type="text" class="form-control" id="newsSearchInput" placeholder="搜尋標題"
                                        oninput="searchNews()">
                                </div>
                                <button class="btn btn-primary col-md-4" data-bs-toggle="modal"
                                    data-bs-target="#addNewsModal">新增消息</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>標題</th>
                                        <th>更新日期</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="newsTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 課程管理頁面 -->
                    <div id="courses" class="tab-content" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2>課程管理</h2>
                            <div class="d-flex align-items-center">
                                <div class="input-group me-2">
                                    <input type="text" class="form-control" id="courseSearchInput" placeholder="搜尋課程名稱"
                                        oninput="searchCourses()">
                                </div>
                                <div class="input-group me-3">
                                    <select class="form-select" id="teacherSearchSelect" onchange="searchCourses()">
                                        <option value="">選擇授課老師</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary col-md-3" data-bs-toggle="modal"
                                    data-bs-target="#addCourseModal">新增課程</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>課程名稱</th>
                                        <th>授課教師</th>
                                        <th>上課時間</th>
                                        <th>費用</th>
                                        <th>人數</th>
                                        <th>狀態</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="coursesTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 成員管理頁面 -->
                    <div id="members" class="tab-content" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2>成員管理</h2>
                            <div class="d-flex align-items-center">
                                <div class="input-group me-2">
                                    <input type="text" class="form-control" id="memberSearchInput" placeholder="搜尋姓名"
                                        oninput="searchMembers()">
                                </div>
                                <div class="input-group me-3">
                                    <select class="form-select" id="titleSearchSelect" onchange="searchMembers()">
                                        <option value="">選擇職稱</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary col-md-3" data-bs-toggle="modal"
                                    data-bs-target="#addMemberModal">新增成員</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>姓名</th>
                                        <th>職稱</th>
                                        <th>電子郵件</th>
                                        <th>聯絡電話</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="membersTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 報名資料管理頁面 -->
                    <div id="registrations" class="tab-content" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2>報名資料管理</h2>
                            <div class="d-flex align-items-center">
                                <div class="input-group me-3">
                                    <select class="form-select" id="registrationCourseSelect"
                                        onchange="searchRegistrations()">
                                        <option value="">選擇課程</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>課程名稱</th>
                                        <th>報名者姓名</th>
                                        <th>電話</th>
                                        <th>報名時間</th>
                                        <th>報名人數</th>
                                        <th>總費用</th>
                                        <th>報到</th>
                                        <th>匯款</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="registrationsTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 活動花絮管理頁面 -->
                    <div id="photoAlbums" class="tab-content" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2>活動花絮管理</h2>
                            <div class="d-flex align-items-center">
                                <div class="input-group me-3">
                                    <input type="text" class="form-control" id="photoAlbumSearchInput" placeholder="搜尋標題"
                                        oninput="searchPhotoAlbums()">
                                </div>
                                <button class="btn btn-primary col-md-3" data-bs-toggle="modal"
                                    data-bs-target="#addPhotoAlbumModal">新增活動花絮</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>標題</th>
                                        <th>更新日期</th>
                                        <th>照片連結</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="photoAlbumsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增消息 Modal -->
    <div class="modal fade" id="addNewsModal" tabindex="-1" aria-labelledby="addNewsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addNewsModalLabel">新增消息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addNewsForm">
                        <div class="mb-3">
                            <label for="newsTitle" class="form-label">標題</label>
                            <input type="text" class="form-control" id="newsTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="newsDescription" class="form-label">內容描述</label>
                            <textarea class="form-control" id="newsDescription" rows="3" required></textarea>
                        </div>
                        <!-- 圖片上傳區塊 (用於各個模態框) -->
                        <div class="mb-3">
                            <label class="form-label">上傳圖片</label>
                            <input type="file" class="form-control" id="newsImageUpload" accept="image/*">
                            <div class="mt-2">
                                <img id="newsImagePreview" src="#" alt="預覽"
                                    style="max-width: 100%; max-height: 200px; display: none;">
                            </div>
                        </div>
                        <!-- URL動態輸入區域 -->
                        <div class="mb-3">
                            <label class="form-label">相關連結</label>
                            <div id="newsUrlContainer">
                                <div class="url-item row mb-2">
                                    <div class="col-4">
                                        <input type="text" class="form-control url-text" placeholder="顯示文字">
                                    </div>
                                    <div class="col-6">
                                        <input type="url" class="form-control url-link" placeholder="連結地址">
                                    </div>
                                    <div class="col-1">
                                        <button type="button" class="btn btn-danger btn-sm remove-url">×</button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addNewsUrlBtn">
                                <i class="bi bi-plus-circle"></i> 新增連結
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addNews()">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增課程 Modal -->
    <div class="modal fade" id="addCourseModal" tabindex="-1" aria-labelledby="addCourseModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCourseModalLabel">新增課程</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addCourseForm">
                        <div class="row mb-3">
                            <!-- 區塊一：課程名稱、授課教師、上課時間 -->
                            <div class="col-6">
                                <div class="mb-3">
                                    <label for="courseTitle" class="form-label">課程名稱</label>
                                    <input type="text" class="form-control" id="courseTitle" required>
                                </div>
                                <div class="mb-3">
                                    <label for="courseTeacher" class="form-label">授課教師</label>
                                    <select class="form-select" id="courseTeacher" required>
                                        <option value="">選擇授課老師</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="courseStartDate" class="form-label">開始時間</label>
                                    <input type="datetime-local" class="form-control" id="courseStartDate" required>
                                </div>
                                <div>
                                    <label for="courseCapacity" class="form-label">上課人數</label>
                                    <input type="number" class="form-control" id="courseCapacity" required min="1">
                                </div>
                            </div>
                            <!-- 區塊二：課程費用、上課地點 -->
                            <div class="col-6">
                                <div class="mb-3">
                                    <label for="coursePrice" class="form-label">課程費用</label>
                                    <input type="number" class="form-control" id="coursePrice" required>
                                </div>
                                <div class="mb-3">
                                    <label for="courseLocation" class="form-label">上課地點</label>
                                    <input type="text" class="form-control" id="courseLocation" required>
                                </div>
                                <div class="mb-3">
                                    <label for="courseEndDate" class="form-label">結束時間</label>
                                    <input type="datetime-local" class="form-control" id="courseEndDate" required>
                                </div>
                                <!-- 圖片上傳區塊 (用於各個模態框) -->
                                <div>
                                    <label class="form-label">上傳圖片</label>
                                    <input type="file" class="form-control" id="courseImageUpload" accept="image/*">
                                    <div class="mt-2">
                                        <img id="courseImagePreview" src="#" alt="預覽"
                                            style="max-width: 100%; max-height: 200px; display: none;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 區塊三：課程簡介 -->
                        <div class="mb-3">
                            <label for="courseDescription" class="form-label">課程簡介</label>
                            <textarea class="form-control" id="courseDescription" rows="3" required></textarea>
                        </div>


                        <!-- URL動態輸入區域 -->
                        <div class="mb-3">
                            <label class="form-label">相關連結</label>
                            <div id="courseUrlContainer">
                                <div class="url-item row mb-2">
                                    <div class="col-4">
                                        <input type="text" class="form-control url-text" placeholder="顯示文字">
                                    </div>
                                    <div class="col-6">
                                        <input type="url" class="form-control url-link" placeholder="連結地址">
                                    </div>
                                    <div class="col-1">
                                        <button type="button" class="btn btn-danger btn-sm remove-url">×</button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addCourseUrlBtn">
                                <i class="bi bi-plus-circle"></i> 新增連結
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addCourse()">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增成員 Modal -->
    <div class="modal fade" id="addMemberModal" tabindex="-1" aria-labelledby="addMemberModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addMemberModalLabel">新增成員</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addMemberForm">
                        <div class="mb-3">
                            <label for="memberName" class="form-label">姓名</label>
                            <input type="text" class="form-control" id="memberName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">職稱/標籤</label>
                            <div class="border p-3 rounded">
                                <div id="memberTagsContainer" class="d-flex flex-wrap gap-2">
                                    <!-- 標籤選項會在這裡動態生成 -->
                                </div>
                            </div>
                            <input type="hidden" id="memberTitle">
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="memberEmail" class="form-label">電子郵件</label>
                                    <input type="email" class="form-control" id="memberEmail" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="memberPhone" class="form-label">聯絡電話</label>
                                    <input type="text" class="form-control" id="memberPhone" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="memberDescription" class="form-label">個人介紹</label>
                            <textarea class="form-control" id="memberDescription" rows="3" required></textarea>
                        </div>
                        <!-- 圖片上傳區塊 (用於各個模態框) -->
                        <div class="mb-3">
                            <label class="form-label">上傳圖片</label>
                            <input type="file" class="form-control" id="memberImageUpload" accept="image/*">
                            <div class="mt-2">
                                <img id="memberImagePreview" src="#" alt="預覽"
                                    style="max-width: 100%; max-height: 200px; display: none;">
                            </div>
                        </div>
                        <!-- URL動態輸入區域 -->
                        <div class="mb-3">
                            <label class="form-label">相關連結</label>
                            <div id="memberUrlContainer">
                                <div class="url-item row mb-2">
                                    <div class="col-4">
                                        <input type="text" class="form-control url-text" placeholder="顯示文字">
                                    </div>
                                    <div class="col-6">
                                        <input type="url" class="form-control url-link" placeholder="連結地址">
                                    </div>
                                    <div class="col-1">
                                        <button type="button" class="btn btn-danger btn-sm remove-url">×</button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addMemberUrlBtn">
                                <i class="bi bi-plus-circle"></i> 新增連結
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addMember()">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增活動花絮 Modal -->
    <div class="modal fade" id="addPhotoAlbumModal" tabindex="-1" aria-labelledby="addPhotoAlbumModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPhotoAlbumModalLabel">新增</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addPhotoAlbumForm">
                        <div class="mb-3">
                            <label for="photoAlbumId" class="form-label">活動編號</label>
                            <input type="text" class="form-control" id="photoAlbumId" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="photoAlbumTitle" class="form-label">活動標題</label>
                            <input type="text" class="form-control" id="photoAlbumTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="photoAlbumUrl" class="form-label">照片連結</label>
                            <input type="url" class="form-control" id="photoAlbumUrl" required>
                            <small class="form-text text-muted">輸入相簿或雲端照片連結</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addPhotoAlbum()">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 使用從 firebase-data.js 引入的 Firebase 物件
        // 不需要重新宣告 auth 和 db

        // 快取管理
        const AdminDataManager = {
            // 更新時間存儲的鍵名
            CACHE_TIME_KEY: 'admin_update_times',

            // 定義需要管理的表格
            TABLES: ['Registration', 'course', 'member', 'news', 'delectlog', 'photo_album'],

            // 獲取更新時間
            getUpdateTimes() {
                const times = localStorage.getItem(this.CACHE_TIME_KEY);
                return times ? JSON.parse(times) : {};
            },

            // 保存更新時間
            saveUpdateTimes(times) {
                localStorage.setItem(this.CACHE_TIME_KEY, JSON.stringify(times));
            },

            // 獲取表格的快取數據
            getTableCache(tableName) {
                const cache = localStorage.getItem(`admin_${tableName}`);
                return cache ? JSON.parse(cache) : [];
            },

            // 保存表格的快取數據
            saveTableCache(tableName, data) {
                localStorage.setItem(`admin_${tableName}`, JSON.stringify(data));
            },

            // 同步單個表格數據
            async syncTable(tableName) {
                try {
                    const updateTimes = this.getUpdateTimes();
                    const lastUpdate = updateTimes[tableName] || 0;
                    const currentTime = new Date().getTime();

                    // 查詢該時間點後的更新
                    let query = window.db.collection(tableName).where('updatetime', '>', new Date(lastUpdate));

                    // 獲取更新的數據
                    const snapshot = await query.get();

                    if (snapshot.empty) {
                        console.log(`${tableName}: 沒有新數據`);
                        return;
                    }

                    // 獲取現有快取
                    let cachedData = this.getTableCache(tableName);

                    // delectlog 表的特殊處理
                    if (tableName === 'delectlog') {
                        // 處理刪除記錄
                        snapshot.forEach(doc => {
                            const deleteInfo = doc.data();
                            const targetTable = deleteInfo.name;
                            const targetId = deleteInfo.id;

                            if (targetTable && targetId) {
                                // 從對應表的快取中刪除記錄
                                const tableCache = this.getTableCache(targetTable);
                                const updatedCache = tableCache.filter(item => item.id !== targetId);
                                this.saveTableCache(targetTable, updatedCache);
                                console.log(`已從 ${targetTable} 中刪除 ID 為 ${targetId} 的記錄`);
                            }
                        });

                        // 更新 delectlog 的時間戳，但不保存其內容
                        cachedData = [];
                    } else {
                        // 其他表格的標準處理
                        // 將新數據與現有快取合併
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            const id = doc.id;

                            // 檢查記錄是否已存在
                            const existingIndex = cachedData.findIndex(item => item.id === id);

                            if (existingIndex >= 0) {
                                // 更新現有記錄
                                cachedData[existingIndex] = { id, ...data };
                            } else {
                                // 添加新記錄
                                cachedData.push({ id, ...data });
                            }
                        });
                    }

                    // 保存更新後的快取
                    this.saveTableCache(tableName, cachedData);

                    // 更新時間戳
                    updateTimes[tableName] = currentTime;
                    this.saveUpdateTimes(updateTimes);

                    console.log(`${tableName}: 已同步 ${snapshot.size} 條記錄`);
                } catch (error) {
                    console.error(`同步 ${tableName} 失敗:`, error);
                }
            },

            // 同步所有表格數據
            async syncAllData() {
                await Promise.all(this.TABLES.map(table => this.syncTable(table)));
                console.log('所有數據同步完成');
            },

            // 清除所有管理員快取
            clearAllAdminCache() {
                this.TABLES.forEach(table => {
                    localStorage.removeItem(`admin_${table}`);
                });
                localStorage.removeItem(this.CACHE_TIME_KEY);
                console.log('已清除所有管理員快取');
            }
        };


        // 監聽認證狀態變化
        window.auth.onAuthStateChanged(async function (user) {
            if (user) {
                // 用戶已登入
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('userEmail').textContent = user.email;

                // 首先同步所有數據
                await AdminDataManager.syncAllData();

                // 然後載入資料到頁面
                loadDashboard();
                TableManager.load('news');
                TableManager.load('course');
                TableManager.load('member');
                TableManager.load('registration');
                TableManager.load('photoAlbum');
            } else {
                // 用戶未登入
                document.getElementById('loginSection').style.display = 'flex';
                document.getElementById('adminPanel').style.display = 'none';
            }
        });

        // 切換頁籤
        function showTab(tabId) {
            // 隱藏所有頁籤
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });

            // 顯示選中的頁籤
            document.getElementById(tabId).style.display = 'block';

            // 更新導航欄高亮
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`.nav-link[onclick="showTab('${tabId}')"]`).classList.add('active');
        }

        // 載入儀表板資料 (修改使用快取數據)
        function loadDashboard() {
            // 使用快取數據
            const newsData = AdminDataManager.getTableCache('news');
            const coursesData = AdminDataManager.getTableCache('course');
            const membersData = AdminDataManager.getTableCache('member');
            const enrollmentsData = AdminDataManager.getTableCache('Registration');

            // 更新統計數據
            document.getElementById('newsCount').textContent = newsData.length;
            document.getElementById('coursesCount').textContent = coursesData.length;
            document.getElementById('membersCount').textContent = membersData.length;
            document.getElementById('registrationsCount').textContent = enrollmentsData.length;

            // 顯示最近的消息
            const recentNewsList = document.getElementById('recentNewsList');
            recentNewsList.innerHTML = '';

            // 按時間排序並取前5條
            const sortedNews = [...newsData].sort((a, b) => {
                // 使用 Firebase Timestamp 格式正確排序
                if (a.updatetime && b.updatetime) {
                    if (a.updatetime.seconds !== b.updatetime.seconds) {
                        return b.updatetime.seconds - a.updatetime.seconds;
                    }
                    return b.updatetime.nanoseconds - a.updatetime.nanoseconds;
                }
                return 0;
            }).slice(0, 5);

            sortedNews.forEach(news => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                const updateDate = news.updatetime ?
                    new Date(news.updatetime.seconds * 1000).toLocaleDateString() : '無日期';
                li.innerHTML = `
                    ${news.title}
                    <small>${updateDate}</small>
                `;
                recentNewsList.appendChild(li);
            });

            // 顯示最近的課程
            const recentRegistrationsList = document.getElementById('recentRegistrationsList');
            recentRegistrationsList.innerHTML = '';

            // 按時間排序並取前5條
            const sortedCourses = [...coursesData].sort((a, b) => {
                // 使用 Firebase Timestamp 格式正確排序
                if (a.updatetime && b.updatetime) {
                    if (a.updatetime.seconds !== b.updatetime.seconds) {
                        return b.updatetime.seconds - a.updatetime.seconds;
                    }
                    return b.updatetime.nanoseconds - a.updatetime.nanoseconds;
                }
                return 0;
            }).slice(0, 5);

            sortedCourses.forEach(course => {
                console.log(course);
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                const updateDate = course.updatetime ?
                    new Date(course.updatetime.seconds * 1000).toLocaleDateString() : '無日期';
                
                // 處理startdate格式
                let formattedDate = '無日期';
                if (course.startdate) {
                    const date = new Date(course.startdate);
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    formattedDate = `${month}-${day}`;
                }

                li.innerHTML = `
                     ${formattedDate} - ${course.title} - ${course.teacher || '無教師'}
                    <small>${updateDate}</small>
                `;
                recentRegistrationsList.appendChild(li);
            });
        }

        // 以下是將表單提交綁定到TableManager
 
        // 當Modal打開時更新授課老師下拉選單
        document.getElementById('addCourseModal').addEventListener('show.bs.modal', function () {
            TableManager.updateTeacherSelect();
        });

        // 當成員Modal打開時，初始化標籤選擇器
        document.getElementById('addMemberModal').addEventListener('show.bs.modal', function () {
            // 檢查當前是否處於編輯模式
            const modalTitle = document.getElementById('addMemberModalLabel').textContent;
            // 只有在「新增成員」模式下才初始化空標籤，編輯模式下保留已設置的標籤
            if (modalTitle === '新增成員') {
                initMemberTags();
            }
        });

        // 初始化成員標籤選擇器
        function initMemberTags(selectedTags = []) {
            const tagsContainer = document.getElementById('memberTagsContainer');
            tagsContainer.innerHTML = '';  // 清空容器                        
            // 可選擇的標籤列表
            const availableTags = ['會長', '理事長', '副理事長', '常務理事', '常務監事', '理事', '監事', '一般會員', '授課講師'];

            // 為每個標籤創建一個 checkbox
            availableTags.forEach(tag => {
                const isChecked = selectedTags.includes(tag);

                const tagDiv = document.createElement('div');
                tagDiv.className = 'form-check';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-check-input';
                checkbox.id = `tag_${tag}`;
                checkbox.value = tag;
                checkbox.checked = isChecked;

                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = `tag_${tag}`;
                label.textContent = tag;

                tagDiv.appendChild(checkbox);
                tagDiv.appendChild(label);
                tagsContainer.appendChild(tagDiv);
            });
        }

        // 添加切換報到狀態的函數
        function toggleCheckIn(id, newStatus) {
            if (!id) return;

            // 更新 Firestore 數據
            window.db.collection('Registration').doc(id).update({
                check_in: newStatus,
                updatetime: firebase.firestore.FieldValue.serverTimestamp()
            })
                .then(() => {
                    // 同步數據後重新加載
                    AdminDataManager.syncTable('Registration').then(() => {
                        searchRegistrations(); // 重新加載顯示的報名資料
                    });

                    const statusText = newStatus ? '已報到' : '未報到';
                    console.log(`報名者狀態已更新為${statusText}`);
                })
                .catch(error => {
                    alert(`更新報到狀態失敗: ${error.message}`);
                });
        }

        // 添加切換匯款狀態的函數
        function togglePaidStatus(id, newStatus) {
            if (!id) return;

            // 更新 Firestore 數據
            window.db.collection('Registration').doc(id).update({
                paid: newStatus,
                updatetime: firebase.firestore.FieldValue.serverTimestamp()
            })
                .then(() => {
                    // 同步數據後重新加載
                    AdminDataManager.syncTable('Registration').then(() => {
                        searchRegistrations(); // 重新加載顯示的報名資料
                    });

                    const statusText = newStatus ? '已匯款' : '未匯款';
                    console.log(`報名者匯款狀態已更新為${statusText}`);
                })
                .catch(error => {
                    alert(`更新匯款狀態失敗: ${error.message}`);
                });
        }

        // 為每個模態視窗的關閉按鈕和取消按鈕添加事件監聽器
        document.querySelectorAll('.modal .btn-close, .modal .btn-secondary').forEach(button => {
            button.addEventListener('click', function () {
                const modalId = this.closest('.modal').id;
                let tableType = '';

                if (modalId === 'addNewsModal') {
                    tableType = 'news';
                } else if (modalId === 'addCourseModal') {
                    tableType = 'course';
                } else if (modalId === 'addMemberModal') {
                    tableType = 'member';
                }else if (modalId === 'addPhotoAlbumModal') {
                    tableType = 'photoAlbum';
                }

                if (tableType) {
                    TableManager.resetForm(tableType);

                    // 確保模態視窗內的元素不會保留焦點
                    setTimeout(() => {
                        document.activeElement.blur();
                        // 將焦點移到一個安全的元素
                        document.querySelector('body').focus();
                    }, 150);
                }
            });
        });

        // 為新增按鈕添加事件監聽器，確保表單被清空
        document.querySelectorAll('[data-bs-toggle="modal"]').forEach(button => {
            button.addEventListener('click', function () {
                const target = this.getAttribute('data-bs-target');
                let tableType = '';

                if (target === '#addNewsModal') {
                    tableType = 'news';
                } else if (target === '#addCourseModal') {
                    tableType = 'course';
                } else if (target === '#addMemberModal') {
                    tableType = 'member';
                }else if (target === '#addPhotoAlbumModal') {
                    tableType = 'photoAlbum';
                }

                if (tableType) {
                    setTimeout(() => TableManager.resetForm(tableType), 100);
                }
            });
        });

        // 修復模態無障礙性問題
        document.querySelectorAll('.modal').forEach(modal => {
            // 當模態隱藏後移除所有可能的焦點
            modal.addEventListener('hidden.bs.modal', function () {
                // 移除所有表單元素的焦點
                const focusableElements = this.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                focusableElements.forEach(el => el.blur());

                // 確保沒有元素保留焦點
                document.activeElement.blur();
                // 將焦點移到一個安全的元素
                document.querySelector('body').focus();
            });
        });

        // 圖片處理函數
        async function handleImageUpload(collectionName, docId, fileInput) {
            if (!fileInput || !fileInput.files || !fileInput.files[0]) return null;

            // 如果沒有docId (新增操作)，先創建一個臨時ID
            const tempId = docId || firebase.firestore().collection(collectionName).doc().id;

            // 轉換圖片為webp格式
            const webpBlob = await convertToWebP(fileInput.files[0], collectionName);

            // 上傳到Storage
            const storageRef = firebase.storage().ref();
            const imageRef = storageRef.child(`${collectionName}/${tempId}.webp`);

            await imageRef.put(webpBlob);

            return tempId; // 返回ID以便保存到文檔
        }

        // 轉換圖片為webp，根據不同的表使用不同的尺寸限制
        async function convertToWebP(file, collectionName) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.onload = function () {
                        // 根據不同的表設置不同的尺寸限制
                        let maxWidth = 800;
                        let maxHeight = 600;

                        // 成員照片限制為250x250
                        if (collectionName === 'member') {
                            maxWidth = 400;
                            maxHeight = 400;
                        } else if (collectionName === 'news') {
                            maxWidth = 800;
                            maxHeight = 450; // 16:9 比例
                        } else if (collectionName === 'course') {
                            maxWidth = 800;
                            maxHeight = 600;
                        }

                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = (maxWidth / width) * height;
                            width = maxWidth;
                        }
                        if (height > maxHeight) {
                            width = (maxHeight / height) * width;
                            height = maxHeight;
                        }
                        // 創建Canvas並轉換為webp
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        // 轉為webp Blob
                        canvas.toBlob(resolve, 'image/webp', 0.8);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // 處理textarea內容，將換行轉換為<br>
        function processTextareaContent(content) {
            if (!content) return '';
            return content.replace(/\n/g, '<br>');
        }

        // 為各個模態框添加URL按鈕點擊事件
        document.getElementById('addNewsUrlBtn').addEventListener('click', function () {
            addUrlField('newsUrlContainer');
        });

        document.getElementById('addCourseUrlBtn').addEventListener('click', function () {
            addUrlField('courseUrlContainer');
        });

        document.getElementById('addMemberUrlBtn').addEventListener('click', function () {
            addUrlField('memberUrlContainer');
        });

        // 修改添加URL輸入行的函數，接受容器ID參數
        function addUrlField(containerId) {
            const urlContainer = document.getElementById(containerId);
            const newUrlItem = document.createElement('div');
            newUrlItem.className = 'url-item row mb-2';
            newUrlItem.innerHTML = `
                <div class="col-4">
                    <input type="text" class="form-control url-text" placeholder="顯示文字">
                </div>
                <div class="col-6">
                    <input type="url" class="form-control url-link" placeholder="連結地址">
                </div>
                <div class="col-1">
                    <button type="button" class="btn btn-danger btn-sm remove-url">×</button>
                </div>
            `;

            urlContainer.appendChild(newUrlItem);

            // 綁定刪除按鈕事件
            newUrlItem.querySelector('.remove-url').addEventListener('click', function () {
                urlContainer.removeChild(newUrlItem);
            });
        }

        // 修改收集URL資料的函數，接受容器ID參數
        function collectUrlData(containerId) {
            const urlItems = document.querySelectorAll(`#${containerId} .url-item`);
            const urls = [];

            urlItems.forEach(item => {
                const text = item.querySelector('.url-text').value.trim();
                const link = item.querySelector('.url-link').value.trim();

                if (text && link) {
                    urls.push(`${text}|||${link}`);
                }
            });

            return urls;
        }

        // 圖片預覽處理
        document.getElementById('newsImageUpload').addEventListener('change', function () {
            previewImage(this, 'newsImagePreview');
        });

        document.getElementById('courseImageUpload').addEventListener('change', function () {
            previewImage(this, 'courseImagePreview');
        });

        document.getElementById('memberImageUpload').addEventListener('change', function () {
            previewImage(this, 'memberImagePreview');
        });

        // 添加圖片預覽函數
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);

            if (input.files && input.files[0]) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };

                reader.readAsDataURL(input.files[0]);
            } else {
                preview.src = '#';
                preview.style.display = 'none';
            }
        }

        // 添加切換課程開課狀態的函數
        function toggleCourseStatus(id, newStatus) {
            if (!id) return;

            // 如果是取消開課，需要額外確認
            if (!newStatus) {
                if (!confirm('確定要取消開課嗎？會向所有已報名學員發送mail通知')) {
                    return;
                }
            }

            // 更新 Firestore 數據
            window.db.collection('course').doc(id).update({
                active: newStatus,
                updatetime: firebase.firestore.FieldValue.serverTimestamp()
            })
                .then(() => {
                    // 同步數據後重新加載
                    AdminDataManager.syncTable('course').then(() => {
                        TableManager.load('course');
                    });

                    const statusText = newStatus ? '開課中' : '已取消';
                    console.log(`課程狀態已更新為${statusText}`);

                    // 如果是取消開課，可以在這裡添加發送郵件通知的代碼
                    if (!newStatus) {
                        // 獲取課程信息
                        window.db.collection('course').doc(id).get().then(doc => {
                            if (doc.exists) {
                                const courseData = doc.data();
                                const courseTitle = courseData.title;

                                // 通知系統管理員
                                console.log(`課程「${courseTitle}」已被取消，應向已報名學員發送通知郵件`);
                            }
                        });
                    }
                })
                .catch(error => {
                    alert(`更新課程狀態失敗: ${error.message}`);
                });
        }

        // 活動花絮相關函數

        // 初始添加AdminDataManager中需要管理的表格
        if (AdminDataManager.TABLES.indexOf('photo_album') === -1) {
            AdminDataManager.TABLES.push('photo_album');
        }
        
      

        // 保存原始的TableManager.edit函數
        const originalEdit = TableManager.edit;
        
        // 修改TableManager的edit函數來為活動花絮添加特殊處理，並處理模態對話框的焦點問題
        TableManager.edit = function(tableType, id) {
            // 如果不是photoAlbum，使用原始的函數
            if (tableType !== 'photoAlbum') {
                return originalEdit.call(this, tableType, id);
            }
            
            const config = TableConfig[tableType];
            
            if (!config) {
                console.error(`TableConfig for ${tableType} not found.`);
                return;
            }
            
            // 從 Firestore 獲取資料
            window.db.collection(config.collectionName).doc(id).get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        data.id = doc.id;
                        
                        // 設置要編輯的資料
                        TableManager.currentEditId = id;
                        
                        // 獲取表單和模態窗口
                        const form = document.getElementById(config.formId);
                        const modal = document.getElementById(config.modalId);
                        const modalLabel = document.getElementById(config.modalLabelId);
                        
                        if (!form || !modal || !modalLabel) {
                            console.error('Form, modal or modalLabel element not found');
                            return;
                        }
                        
                        // 更新表單元素
                        for (const [fieldName, elementId] of Object.entries(config.formFields)) {
                            const element = document.getElementById(elementId);
                            if (element) {
                                element.value = data[fieldName] || '';
                            }
                        }
                        
                        // 更新標題
                        modalLabel.textContent = '編輯活動花絮';
                        
                        // 清除現有的按鈕事件監聽器並設置新的
                        const submitButton = form.querySelector('button[type="submit"]');
                        if (submitButton) {
                            submitButton.textContent = '更新';
                            
                            // 移除先前的事件監聽器
                            const newSubmitButton = submitButton.cloneNode(true);
                            submitButton.parentNode.replaceChild(newSubmitButton, submitButton);
                            
                            // 添加新的事件監聽器 - 使用自定義的提交函數
                            newSubmitButton.onclick = function(e) {
                                e.preventDefault();
                                addPhotoAlbum(id);
                            };
                        }
                        
                        // 顯示模態窗口 - 使用不同的方式打開模態框，避免焦點問題
                        setTimeout(() => {
                            // 確保任何其他元素失去焦點
                            document.activeElement.blur();
                            
                            // 顯示模態窗口
                            const modalInstance = new bootstrap.Modal(modal);
                            modalInstance.show();
                            
                            // 模態窗口打開後將焦點轉移到第一個輸入欄位
                            modal.addEventListener('shown.bs.modal', function() {
                                const firstInput = form.querySelector('input, textarea, select');
                                if (firstInput) {
                                    firstInput.focus();
                                }
                            }, { once: true });
                        }, 100);
                    } else {
                        alert('找不到要編輯的資料');
                    }
                })
                .catch(error => {
                    console.error('獲取資料失敗:', error);
                    alert(`獲取資料失敗: ${error.message}`);
                });
        };

    </script>
</body>
</html>