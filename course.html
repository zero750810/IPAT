<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>課程介紹 - 國際遊戲協會</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <!-- Header -->
    <header class="bg-light py-3">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-5 d-flex justify-content-center">
                    <img src="img/logogif.gif" alt="Logo" class="img-fluid" style="max-width: 80px;">
                </div>
                <div class="col-md-7">
                    <nav class="d-flex justify-content-center">
                        <ul class="nav">
                            <li class="nav-item"><a class="nav-link" href="index.html">首頁</a></li>
                            <li class="nav-item"><a class="nav-link" href="about.html">關於我們</a></li>
                            <li class="nav-item"><a class="nav-link" href="member.html">成員介紹</a></li>
                            <li class="nav-item"><a class="nav-link" href="news.html">最新消息</a></li>
                            <li class="nav-item"><a class="nav-link" href="course.html">課程介紹</a></li>
                            <li class="nav-item"><a class="nav-link" href="contact.html">聯絡我們</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </header>

    <!-- Course Banner -->
    <div class="container-fluid">
        <img src="img/course-banner.jpg" alt="Banner" class="img-fluid w-100">
    </div>

    <!-- Course Information -->
    <section class="py-5">
        <div class="container">
            <h2 class="text-center text-warning mb-4">課程須知</h2>
            <p>歡迎加入我們遊戲學習的行列，為了讓您學習順利，請仔細閱讀下方條款，並熟悉學習規範：</p>

            <div class="accordion mb-5" id="courseAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOne">
                        <button class="accordion-button collapsed bg-primary text-white" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false"
                            aria-controls="collapseOne">
                            課程通知及未開成班通知
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne"
                        data-bs-parent="#courseAccordion">
                        <div class="accordion-body">
                            <ol>
                                <li>本會課程皆以能開成班為前提，如無特殊狀況，最遲於開課前2至3天於本會網站公告上課時間與地點，不另行電話通知，敬請密切注意本會官網公告。
                                </li>
                                <li>課程如因「未達開班人數」或「其他原因」，而無法開班，將於開課日前2至3天前在本會網站公告，您可選擇辦理保留轉班或退費。</li>
                                <li>本會課程開班訊息及相關資訊，均以本會網站公告為準。</li>
                            </ol>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTwo">
                        <button class="accordion-button collapsed bg-primary text-white" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false"
                            aria-controls="collapseTwo">
                            課程異動通知
                        </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo"
                        data-bs-parent="#courseAccordion">
                        <div class="accordion-body">
                            <ol>
                                <li>本會保留調整、修訂課程時間、上課地點及老師之權利，如不得已須異動時，異動資訊將在開課前2至3天公布至本會網站。</li>
                                <li>完成報名手續至上課前，課程資訊若有異動，請密切注意本會官網公告。不另以電話通知。</li>
                            </ol>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingThree">
                        <button class="accordion-button collapsed bg-primary text-white" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false"
                            aria-controls="collapseThree">
                            報名及退費
                        </button>
                    </h2>
                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree"
                        data-bs-parent="#courseAccordion">
                        <div class="accordion-body">
                            <ol>
                                <li>報名時請以ATM轉帳<br>
                                    戶名:國際遊戲協會台灣分會<br>
                                    銀行代號： 007<br>
                                    帳號：17610028630<br>
                                    轉帳後請來電告知您的大名及帳號後5碼。
                                </li>
                                <li>開課前二週取消上課退費者，退還已繳費用95%。開課前一週取消上課退費者，退還已繳費用75%。開課前5日內因須於課前備妥材料恕不退費。</li>
                                <li>無論退費原因為何，退費時，本會將扣除應退費總金額2%之ATM轉帳手續費。</li>
                                <li>請學員妥慎保管ATM轉帳繳費明細正本，必要時，憑正本辦理退費。</li>
                            </ol>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingFour">
                        <button class="accordion-button collapsed bg-primary text-white" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false"
                            aria-controls="collapseFour">
                            其他注意事項
                        </button>
                    </h2>
                    <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour"
                        data-bs-parent="#courseAccordion">
                        <div class="accordion-body">
                            <ol>
                                <li>上課時手機請關靜音，若需接聽電話時請到教室外，避免干擾課程進行。</li>
                                <li>如遇颱風，上課與否，依照電台或電視台播報政府之規定辦理，本會不另行個別通知。</li>
                                <li>本會不設旁聽席，不接受錄影、照相及攜帶寵物上課。</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <h2 class="text-center text-warning mb-4">最新課程</h2>
            <div class="col-md-12">
                <div class="row" id="course-container">
                    <!-- 這裡的內容將由 JavaScript 動態生成 -->
                </div>
            </div>
        </div>
    </section>

    <!-- 課程詳情 Modal -->
    <div class="modal fade" id="courseDetailModal" tabindex="-1" aria-labelledby="courseDetailModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="courseDetailModalLabel">課程詳情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="courseDetailContent">
                    <!-- 這裡的內容將由 JavaScript 動態生成 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    <button type="button" class="btn btn-primary" id="enrollCourseBtn">報名課程</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 報名表單 Modal -->
    <div class="modal fade" id="enrollModal" tabindex="-1" aria-labelledby="enrollModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="enrollModalLabel">課程報名</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="enrollForm">
                        <input type="hidden" id="courseId" name="courseId">
                        <input type="hidden" id="courseName" name="courseName">
                        <div class="mb-3">
                            <label for="name" class="form-label">姓名</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">電話</label>
                            <input type="tel" class="form-control" id="phone" name="phone" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">聯絡信箱</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="participants" class="form-label">報名人數</label>
                            <input type="number" class="form-control" id="participants" name="participants" min="1"
                                value="1" onchange="calculateTotal()">
                        </div>
                        <div class="mb-3">
                            <label for="totalFee" class="form-label">費用試算</label>
                            <input type="text" class="form-control" id="totalFee" readonly>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitEnrollment()">確認送出</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 報名成功 Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="successModalLabel">報名結果</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="successModalBody">
                    <!-- 內容將由 JavaScript 動態填充 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">確定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-functions-compat.js"></script>
    <script src="js/firebase-data.js"></script>
    <script src="js/course.js"></script>

    <script>
        let currentCourse = null;

        // 頁面加載時獲取課程資料
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                console.log("course.html 開始載入資料");

                // 確認 dataManager 是否正確初始化
                if (!window.dataManager) {
                    console.error("dataManager 未初始化");
                    alert("資料管理器初始化失敗，請重新載入頁面");
                    return;
                }

                const coursesData = await window.dataManager.getCourses();
                renderCourses(coursesData);
            } catch (error) {
                console.error('載入課程資料時出錯:', error);
            }
        });

        // 動態生成課程卡片
        function renderCourses(courses) {
            const courseContainer = document.getElementById('course-container');
            courseContainer.innerHTML = '';

            if (!courses || courses.length === 0) {
                courseContainer.innerHTML = '<div class="col-12 text-center"><p>目前沒有可用的課程資訊</p></div>';
                return;
            }

            // 過濾出狀態為active的課程，如果active屬性不存在，默認為true
            const activeCourses = courses.filter(course => course.active !== false);

            if (activeCourses.length === 0) {
                courseContainer.innerHTML = '<div class="col-12 text-center"><p>目前沒有開放報名的課程</p></div>';
                return;
            }

            activeCourses.forEach(course => {
                const courseCard = document.createElement('div');
                courseCard.className = 'col-md-3 mb-4';
                courseCard.innerHTML = `
                    <div class="card h-100" style="cursor: pointer;" onclick="showCourseDetail('${course.id}')">
                        <div class="card-body">
                            <h5 class="card-title">${course.title || '無標題'}</h5>
                            <p class="card-text">
                                <small class="text-muted">授課教師: ${course.teacher || '未指定'}</small><br>
                                <small class="text-muted">上課時間: ${formatCourseTime(course)}</small><br>
                                <small class="text-muted">課程費用: NT＄${course.price || 0}</small>
                                ${course.capacity ? `<br><small class="text-muted">課程人數: ${course.capacity} 人</small>` : ''}
                            </p>
                        </div>
                    </div>
                `;
                courseContainer.appendChild(courseCard);
            });
        }
        // 格式化課程時間
        function formatCourseTime(course) {
            // 如果有 time 或 date 屬性，優先使用
            if (course.time) return course.time;
            if (course.date) return course.date;

            // 如果有 startdate 和 enddate
            if (course.startdate && course.enddate) {
                let startDate, endDate;

                // 處理不同的日期格式
                if (typeof course.startdate === 'string') {
                    startDate = new Date(course.startdate);
                } else if (course.startdate.toDate) {
                    // Firestore Timestamp
                    startDate = course.startdate.toDate();
                } else {
                    startDate = new Date(course.startdate);
                }

                if (typeof course.enddate === 'string') {
                    endDate = new Date(course.enddate);
                } else if (course.enddate.toDate) {
                    // Firestore Timestamp
                    endDate = course.enddate.toDate();
                } else {
                    endDate = new Date(course.enddate);
                }

                // 格式化日期
                const formatDate = (date) => {
                    return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
                };

                // 格式化時間
                const formatTime = (date) => {
                    return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                };

                // 檢查是否同一天
                const isSameDay = startDate.getFullYear() === endDate.getFullYear() &&
                    startDate.getMonth() === endDate.getMonth() &&
                    startDate.getDate() === endDate.getDate();

                if (isSameDay) {
                    return `${formatDate(startDate)} ${formatTime(startDate)}~${formatTime(endDate)}`;
                } else {
                    return `${formatDate(startDate)} ${formatTime(startDate)}~${formatDate(endDate)} ${formatTime(endDate)}`;
                }
            }

            return '無資料';
        }

        // 顯示課程詳情
        async function showCourseDetail(courseId) {
            try {
                const courses = await window.dataManager.getCourses();
                currentCourse = courses.find(c => c.id === courseId);

                if (!currentCourse) {
                    console.error('找不到指定課程:', courseId);
                    return;
                }

                // 檢查課程是否已取消
                if (currentCourse.active === false) {
                    alert('此課程已取消開課，無法報名');
                    return;
                }

                const modalTitle = document.getElementById('courseDetailModalLabel');
                const modalContent = document.getElementById('courseDetailContent');

                modalTitle.textContent = currentCourse.title || '未命名課程';
                
                // 添加課程容量信息
                const capacityInfo = currentCourse.capacity 
                    ? `<div class="col-md-2"><strong>課程人數：</strong><br>${currentCourse.capacity} 人</div>` 
                    : '';
                
                modalContent.innerHTML = `
                    <div class="row">
                    <div id="course-image-container" class="col-md-12 mb-3" style="display: none;">
                        <!-- 圖片將在下方動態添加 -->
                    </div>
                    <div class="col-md-12">
                        <div class="row">
                            <div class="col-md-2">
                                <strong>授課教師：</strong><br>${currentCourse.teacher || '無資料'}
                            </div>                            
                            <div class="col-md-2">
                                <strong>課程費用：</strong><br>${currentCourse.price || '無資料'}
                            </div>
                            <div class="col-md-3">
                                <strong>上課時間：</strong><br>${formatCourseTime(currentCourse)}
                            </div>
                            <div class="col-md-3">
                                <strong>上課地點：</strong><br>${currentCourse.location || '無資料'}
                            </div>
                            ${capacityInfo}
                        </div>
                    </div>
                    <div class="col-md-12 mt-3">
                        <p>${currentCourse.content || currentCourse.description || '無課程描述'}</p>
                        ${renderUrlLinks(currentCourse.urls)}
                    </div>
                </div>
                `;
                
                // 嘗試從 Firebase Storage 獲取圖片
                if (currentCourse.id) {
                    const imageUrl = `https://firebasestorage.googleapis.com/v0/b/ipat-database.firebasestorage.app/o/course%2F${currentCourse.id}.webp?alt=media`;              
                    const img = new Image();
                    const imageContainer = document.getElementById('course-image-container');

                    img.onload = function () {
                        // 圖片載入成功時顯示
                        img.className = 'img-fluid';
                        img.alt = currentCourse.title || '課程圖片';
                        imageContainer.innerHTML = '';
                        imageContainer.appendChild(img);
                        imageContainer.style.display = 'block';
                    };

                    img.onerror = function () {
                        // 圖片載入失敗時隱藏容器
                        console.log(`無法載入課程 ${currentCourse.id} 的圖片`);
                        imageContainer.style.display = 'none';
                    };

                    img.src = imageUrl;
                }
                
                const modal = new bootstrap.Modal(document.getElementById('courseDetailModal'));
                modal.show();
            } catch (error) {
                console.error('獲取課程詳情時出錯:', error);
            }
        }

        // 報名課程按鈕點擊事件
        document.getElementById('enrollCourseBtn').addEventListener('click', function () {
            if (!currentCourse) return;

            // 關閉課程詳情 Modal
            const courseDetailModal = bootstrap.Modal.getInstance(document.getElementById('courseDetailModal'));
            courseDetailModal.hide();

            // 設置報名表單的課程相關資訊
            document.getElementById('courseId').value = currentCourse.id;
            document.getElementById('courseName').value = currentCourse.title;

            // 計算初始費用
            calculateTotal();

            // 顯示報名表單 Modal
            const enrollModal = new bootstrap.Modal(document.getElementById('enrollModal'));
            enrollModal.show();
        });

        // 計算總費用
        function calculateTotal() {
            const participants = parseInt(document.getElementById('participants').value) || 1;
            const totalFee = participants * (currentCourse?.price || 0);
            document.getElementById('totalFee').value = `NT$${totalFee}`;
        }

        // 提交報名表單
        async function submitEnrollment() {
            const enrollForm = document.getElementById('enrollForm');

            // 表單驗證
            if (!enrollForm.checkValidity()) {
                enrollForm.reportValidity();
                return;
            }

            try {
                // 顯示處理中的提示
                const submitBtn = document.querySelector('#enrollModal .modal-footer .btn-primary');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = '處理中...';

                // 準備報名資料
                const enrollmentData = {
                    courseId: document.getElementById('courseId').value,
                    name: document.getElementById('name').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    participants: parseInt(document.getElementById('participants').value) || 1,
                    courseName: document.getElementById('courseName').value,
                    totalFee: document.getElementById('totalFee').value                    
                };
                console.log(enrollmentData);
                // 使用 Firebase Functions 處理報名邏輯
                const processEnrollment = firebase.functions().httpsCallable('processEnrollment');
                const result = await processEnrollment(enrollmentData);
                
                // 恢復按鈕狀態
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;

                // 關閉報名表單 Modal
                const enrollModal = bootstrap.Modal.getInstance(document.getElementById('enrollModal'));
                enrollModal.hide();

                // 清空表單
                document.getElementById('enrollForm').reset();

                // 根據結果顯示相應訊息
                const successModalBody = document.getElementById('successModalBody');
                const successModalLabel = document.getElementById('successModalLabel');
                
                if (result.data.success) {
                    // 報名成功
                    successModalLabel.textContent = '報名成功';
                    successModalBody.innerHTML = `
                        <div class="alert alert-success" role="alert">
                            <h4 class="alert-heading">恭喜！</h4>
                            <p>${result.data.message}</p>
                            <hr>
                            <p class="mb-0">報名資訊已記錄，我們將盡快與您聯繫確認。<br>
                            報名資訊已發送至您的電子郵件信箱。</p>
                        </div>
                    `;
                } else {
                    // 報名失敗
                    successModalLabel.textContent = '報名未完成';
                    successModalBody.innerHTML = `
                        <div class="alert alert-warning" role="alert">
                            <h4 class="alert-heading">提醒</h4>
                            <p>${result.data.message}</p>
                            <hr>
                            <p class="mb-0">如有問題，請聯繫我們的客服人員。</p>
                        </div>
                    `;
                }

                // 顯示結果 Modal
                const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                successModal.show();
            } catch (error) {
                console.error('報名提交時出錯:', error);
                alert(`報名提交時發生錯誤: ${error.message}`);
            }
        }

        // 處理URLs數組，將其轉換為HTML連結
        function renderUrlLinks(urls) {
            if (!urls || !Array.isArray(urls) || urls.length === 0) {
                return '';
            }

            let linksHtml = '<div class="col-md-12 mb-3"><div class="d-flex flex-wrap gap-2">';

            urls.forEach(urlItem => {
                const parts = urlItem.split('|||');
                if (parts.length === 2) {
                    const [text, link] = parts;
                    linksHtml += `<a href="${link}" class="btn btn-sm btn-outline-primary col-2" target="_blank">${text}</a>`;

                }
            });

            linksHtml += '</div></div>';
            return linksHtml;
        }
    </script>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-3">
                    <div class="text-center">
                        <img src="img/logo-150x150.jpeg" alt="Logo" class="img-fluid mb-2" style="max-width: 100px;">
                    </div>
                    <p>遊戲 是最高形式的研究；樂育 是最高層次的學習。<br>
                        Play, is research in its highest form.<br>
                        Edutainment, is learning on its highest level.</p>
                </div>
                <div class="col-lg-4 mb-3">
                    <ul class="list-unstyled">
                        <li><i class="fa fa-map-marker"></i> 地址：116台北市文山區景福街3巷21號</li>
                        <!--li><i class="fa fa-fax"></i> 傳真：(02)8972-7185</li-->
                        <li><i class="fa fa-envelope"></i> E-mail：<a href="mailto:ipat1080224@gmail.com"
                                class="text-white">ipat1080224@gmail.com</a></li>
                    </ul>
                </div>
                <div class="col-lg-4 text-center mb-3">
                    <ul class="list-inline">
                        <li class="list-inline-item"><a
                                href="https://www.facebook.com/IPAT-International-Play-Association-Taiwan-Branch-106772071551600"
                                target="_blank" rel="noopener noreferrer"><img src="img/facebook.png" alt="Facebook"
                                    class="img-fluid" style="max-width: 30px;"></a></li>
                        <li class="list-inline-item"><a
                                href="https://line.me/ti/g2/ftLDwke6OMbboIQNbkGf4Q?utm_source=invitation&amp;utm_medium=link_copy&amp;utm_campaign=default"
                                target="_blank" rel="noopener noreferrer"><img src="img/line.png" alt="Line"
                                    class="img-fluid" style="max-width: 30px;"></a></li>
                        <li class="list-inline-item"><a href="https://twitter.com/ipataiwan1" target="_blank"
                                rel="noopener noreferrer"><img src="img/twitter.png" alt="Twitter" class="img-fluid"
                                    style="max-width: 30px;"></a></li>
                        <li class="list-inline-item"><a href="https://www.instagram.com/ipataiwan/" target="_blank"
                                rel="noopener noreferrer"><img src="img/IG.png" alt="Instagram" class="img-fluid"
                                    style="max-width: 30px;"></a></li>
                        <li class="list-inline-item">
                            <a href="Backstage.html" target="_blank" rel="noopener noreferrer">
                                <img src="img/transparent.png" alt="Backstage" class="img-fluid"
                                    style="max-width: 30px; opacity: 0;">
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="text-center mt-3">
                <p>© Copyright 2025. 網頁設計 By Zero.Lin</p>
            </div>
        </div>
    </footer>

</body>

</html>