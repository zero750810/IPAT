<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>最新消息 - 國際遊戲協會</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        main {
            flex: 1;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <!-- Header -->
    <header class="bg-light py-3">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-5 d-flex justify-content-center">
                    <img src="img/logogif.gif" alt="Logo" class="img-fluid" style="max-width: 80px;">
                </div>
                <div class="col-md-7">
                    <nav class="d-flex justify-content-center">
                        <ul class="nav">
                            <li class="nav-item"><a class="nav-link" href="index.html">首頁</a></li>
                            <li class="nav-item"><a class="nav-link" href="about.html">關於我們</a></li>
                            <li class="nav-item"><a class="nav-link" href="member.html">成員介紹</a></li>
                            <li class="nav-item"><a class="nav-link" href="news.html">最新消息</a></li>
                            <li class="nav-item"><a class="nav-link" href="course.html">課程介紹</a></li>
                            <li class="nav-item"><a class="nav-link" href="contact.html">聯絡我們</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <section class="py-5">
            <div class="container">
                <div class="row">
                    <div class="col-md-12">
                        <h2 class="text-center text-warning mb-4">最新消息</h2>
                        <div id="news-list" class="row row-cols-1 row-cols-md-3 g-4">
                            <!-- 動態插入新聞資料 -->
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 新聞詳情模態框 -->
    <div class="modal fade" id="newsDetailModal" tabindex="-1" aria-labelledby="newsDetailModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newsDetailModalLabel">新聞詳情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="newsDetailContent">
                    <!-- 動態插入新聞詳情 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-3">
                    <div class="text-center">
                        <img src="img/logo-150x150.jpeg" alt="Logo" class="img-fluid mb-2" style="max-width: 100px;">
                    </div>
                    <p>遊戲 是最高形式的研究；樂育 是最高層次的學習。<br>
                        Play, is research in its highest form.<br>
                        Edutainment, is learning on its highest level.</p>
                </div>
                <div class="col-lg-4 mb-3">
                    <ul class="list-unstyled">
                        <li><i class="fa fa-map-marker"></i> 地址：116台北市文山區景福街3巷21號</li>
                        <!--li><i class="fa fa-fax"></i> 傳真：(02)8972-7185</li-->
                        <li><i class="fa fa-envelope"></i> E-mail：<a href="mailto:ipat1080224@gmail.com"
                                class="text-white">ipat1080224@gmail.com</a></li>
                    </ul>
                </div>
                <div class="col-lg-4 text-center mb-3">
                    <ul class="list-inline">
                        <li class="list-inline-item"><a
                                href="https://www.facebook.com/IPAT-International-Play-Association-Taiwan-Branch-106772071551600"
                                target="_blank" rel="noopener noreferrer"><img src="img/facebook.png" alt="Facebook"
                                    class="img-fluid" style="max-width: 30px;"></a></li>
                        <li class="list-inline-item"><a
                                href="https://line.me/ti/g2/ftLDwke6OMbboIQNbkGf4Q?utm_source=invitation&amp;utm_medium=link_copy&amp;utm_campaign=default"
                                target="_blank" rel="noopener noreferrer"><img src="img/line.png" alt="Line"
                                    class="img-fluid" style="max-width: 30px;"></a></li>
                        <li class="list-inline-item"><a href="https://twitter.com/ipataiwan1" target="_blank"
                                rel="noopener noreferrer"><img src="img/twitter.png" alt="Twitter" class="img-fluid"
                                    style="max-width: 30px;"></a></li>
                        <li class="list-inline-item"><a href="https://www.instagram.com/ipataiwan/" target="_blank"
                                rel="noopener noreferrer"><img src="img/IG.png" alt="Instagram" class="img-fluid"
                                    style="max-width: 30px;"></a></li>
                        <li class="list-inline-item">
                            <a href="Backstage.html" target="_blank" rel="noopener noreferrer">
                                <img src="img/transparent.png" alt="Backstage" class="img-fluid"
                                    style="max-width: 30px; opacity: 0;">
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="text-center mt-3">
                <p>© Copyright 2025. 網頁設計 By Zero.Lin</p>
            </div>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="js/news.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-auth-compat.js"></script>
    <script src="js/firebase-data.js"></script>

    <script>
        // 使用 DataManager 獲取新聞資料
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                console.log("news.html 開始載入資料");

                // 確認 dataManager 是否正確初始化
                if (!window.dataManager) {
                    console.error("dataManager 未初始化");
                    alert("資料管理器初始化失敗，請重新載入頁面");
                    return;
                }

                const newsData = await window.dataManager.getNews();
                console.log("獲取到新聞資料:", newsData);

                // 顯示所有新聞（已按updatetime排序）
                displayNewsCards(newsData);
            } catch (error) {
                console.error('載入新聞資料時出錯:', error);
            }
        });

        // 顯示新聞卡片
        function displayNewsCards(newsItems) {
            const newsList = document.getElementById('news-list');
            newsList.innerHTML = '';

            if (!newsItems || newsItems.length === 0) {
                newsList.innerHTML = '<div class="col-12 text-center"><p>沒有可用的新聞資訊</p></div>';
                return;
            }

            // 為每條新聞創建卡片
            newsItems.forEach((news, index) => {
                // 格式化日期顯示
                let dateDisplay = '無日期';
                if (news.updatetime) {
                    const date = typeof news.updatetime === 'number'
                        ? new Date(news.updatetime)
                        : new Date(news.updatetime);
                    dateDisplay = date.toLocaleDateString('zh-TW', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }

                const newsCard = document.createElement('div');
                newsCard.className = 'col';
                newsCard.innerHTML = `
                    <div class="card h-100" style="cursor: pointer;" onclick="showNewsDetail(${index})">
                        <div class="card-body">
                            <h5 class="card-title">${news.title || '無標題'}</h5>
                            <p class="card-text text-muted">${news.content ? news.content.substring(0, 20) + (news.content.length > 20 ? '...' : '') : '點擊查看詳情'}</p>
                        </div>
                        <div class="card-footer">
                            <small class="text-muted">${dateDisplay}</small>
                        </div>
                    </div>
                `;
                newsList.appendChild(newsCard);
            });

            // 儲存新聞數據供模態框使用
            window.allNewsItems = newsItems;
        }

        // 顯示新聞詳情模態框
        function showNewsDetail(index) {
            const news = window.allNewsItems[index];
            if (!news) return;

            // 格式化日期顯示
            let dateDisplay = '無日期';
            if (news.updatetime) {
                const date = typeof news.updatetime === 'number'
                    ? new Date(news.updatetime)
                    : new Date(news.updatetime);
                dateDisplay = date.toLocaleDateString('zh-TW', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            // 設置模態框標題和內容
            document.getElementById('newsDetailModalLabel').textContent = news.title || '無標題';

            const modalContent = document.getElementById('newsDetailContent');

            // 先顯示除圖片外的內容
            modalContent.innerHTML = `
                <div class="row">
                    <div id="news-image-container" class="col-md-12" style="display: none;">
                        <!-- 圖片將在下方動態添加 -->
                    </div>
                    <div class="col-md-12 mt-3">
                        <p>${news.content || '無內容'}</p>
                        ${news.description ? `<p><strong>簡介：</strong> ${news.description}</p>` : ''}
                    </div>
                    ${renderUrlLinks(news.urls)}
                    <div class="col-md-12">
                       <small class="text-muted">更新時間：${dateDisplay}</small>
                    </div>
                </div>
            `;

            // 嘗試從 Firebase Storage 獲取圖片
            if (news.id) {
                const imageUrl = `https://firebasestorage.googleapis.com/v0/b/ipat-database.firebasestorage.app/o/news%2F${news.id}.webp?alt=media`;
                const img = new Image();
                const imageContainer = document.getElementById('news-image-container');

                img.onload = function () {
                    // 圖片載入成功時顯示
                    img.className = 'img-fluid';
                    img.alt = news.title || '新聞圖片';
                    imageContainer.innerHTML = '';
                    imageContainer.appendChild(img);
                    imageContainer.style.display = 'block';
                };

                img.onerror = function () {
                    // 圖片載入失敗時隱藏容器
                    console.log(`無法載入新聞 ${news.id} 的圖片`);
                    imageContainer.style.display = 'none';
                };

                img.src = imageUrl;
            }

            // 顯示模態框
            new bootstrap.Modal(document.getElementById('newsDetailModal')).show();
        }

        // 處理URLs數組，將其轉換為HTML連結
        function renderUrlLinks(urls) {
            if (!urls || !Array.isArray(urls) || urls.length === 0) {
                return '';
            }

            let linksHtml = '<div class="col-md-12 mb-3"><div class="d-flex flex-wrap gap-2">';

            urls.forEach(urlItem => {
                const parts = urlItem.split('|||');
                if (parts.length === 2) {
                    const [text, link] = parts;
                    linksHtml += `<a href="${link}" class="btn btn-sm btn-outline-primary col-2" target="_blank">${text}</a>`;
                }
            });

            linksHtml += '</div></div>';
            return linksHtml;
        }
    </script>
</body>

</html>